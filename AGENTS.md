# AGENTS.md — Web番組表（EPG）埋め込みモジュール

## 1. 目的
既存Webサイトに「テレビ番組表」を埋め込める **クライアントサイドJSモジュール**を実装する。

- **→方向がチャンネル、↓方向が時刻**
- **ページ切替なし**（縦スクロールで8日分を連続表示）
- **地上波 / BS / CS のタブ切替**
- 既存ページは **Bootstrap 5.3**（ダークモード有効）なので、モジュールもそれに馴染む見た目にする
- スマホでも見られるよう **レスポンシブ**かつ **描画コストを抑える**

## 2. 成果物（Deliverables）
- `dist/epg-widget.js`：単体で動く配布物（`<script>` で読み込める形式。UMD推奨）
- `dist/epg-widget.css`：スタイル（Bootstrapと共存できるよう命名衝突を避ける）
- `demo/index.html`：Bootstrap 5.3 を読み込んだデモ（タブ/日付リンク/スクロールを確認できる）
- `README.md`：導入手順・設定項目・APIの期待形式・既知の制限

## 3. 埋め込み方式（Integration Contract）
### 3.1 HTML
ページ側は、番組表を表示したい場所にコンテナ要素を1つ置く。

例：
```html
<div id="epg-root"></div>
<link rel="stylesheet" href="/assets/epg-widget.css">
<script src="/assets/epg-widget.js"></script>
<script>
  EPGWidget.mount("#epg-root", {
    endpoints: {
      servicesUrl: "https://example.com/api/services",
      channelsUrl: "https://example.com/api/channels",
      programsUrl: "https://example.com/api/programs"
    }
  });
</script>
```

### 3.2 初期化API
- グローバル `EPGWidget.mount(target, config)` を提供する
- `target` は `CSS selector` または `HTMLElement`
- `mount()` は複数回呼ばれても安全（同一targetなら再マウント/再描画ができるか、明確に禁止してエラーにする）

## 4. UI要件
### 4.1 全体の構造
- 上部：`GR / BS / CS` タブ
- 上部：日付リンク（8日分：今日〜7日後）
- 本体：グリッド（横＝チャンネル、縦＝時刻）
- 縦方向は 8日分が連続しており、日付リンクは「ページ遷移なしで該当日の先頭へスクロール」する

### 4.2 タブ（GR/BS/CS）
- タブ切替はページ遷移なしで即時に切り替える
- 切替時の挙動（要件）：
  - 可能なら **縦スクロール位置を維持**
  - 難しい場合は「そのタブの当日先頭」に移動でも可（READMEに明記）

### 4.3 日付リンク（8日）
- 8日分のリンクを表示（例：`12/27(土)` 形式）
- クリックで該当日のセクションへスクロール（`scrollIntoView()` 等）
- 日付セクションの見出しは視認性を確保（できれば `position: sticky`）

### 4.4 番組セル
- セルは最低限以下を表示
  - タイトル
  - 放送開始〜終了（開始時刻＋durationから算出）
- クリック/タップで詳細表示（PopoverまたはModal）
  - 表示候補：説明、拡張情報、ジャンル、無料/有料
  - 詳細UIはBootstrapに馴染むこと

### 4.5 “いま放送中”
- 現在時刻が可視範囲にある場合、以下のいずれかで分かるようにする
  - 現在時刻ライン（推奨）
  - いま放送中番組のハイライト

## 5. デザイン要件（Bootstrap 5.3 / ダークモード）
- 既存ページが `data-bs-theme="dark"` のとき、モジュールも自然にダーク表示になること
- Bootstrapユーティリティ（`bg-body`, `text-body`, `border`, `badge`, `nav-tabs` 等）を活用して馴染ませる
- 独自CSSは `epg-` 接頭辞で命名し、Bootstrapと衝突しないようにする

## 6. API要件（重要）
### 6.1 エンドポイント
APIは **3つに分かれている**：
- `servicesUrl`：サービス一覧（ロゴ・リモコン番号等のメタ）
- `channelsUrl`：チャンネル束（同一物理チャンネルに属する service のまとまり）
- `programsUrl`：番組一覧（**8日分を一括で返す**）

### 6.2 取得タイミング
- 初期化時に3つを取得し、UIを構築する
- `programsUrl` は大きい可能性が高いので、UIの初期表示体感を落とさない工夫をする（例：ローディング→段階描画）

## 7. チャンネル列の要件（最重要：GR/BSのサブチャンネル統合）
### 7.1 “表示列”の定義
番組表における列（ユーザーが見る縦レーン）を以下のルールで作る：

- **GR/BS：channels の「1要素」を 1列（表示列）として扱う**
  - 同一物理チャンネル内の複数service（メイン/サブ等）は原則まとめる
- **CS：serviceId ごとに 1列（表示列）**
  - CSはまとめず、従来どおり個別列で良い

※ channels内には表示対象外の service も混ざり得るため、デフォルトでは `service.type === 1` のものだけ表示対象とする（設定で変更可）。

### 7.2 GR/BS統合列の “列内横並び” 表示
GR/BS統合列は、通常は「共通番組が多い」ため 1本のレーンとして見せたい。  
しかしサブチャンネルだけ別番組になることがあるので、**その時間帯に限って**列内を横分割して並べる。

要件：
- 同一時間枠に **異なる番組が複数存在**する場合：
  - 統合列のその時間帯は **横分割（2〜N分割）**して表示する
- 共通番組（サイマル）と判定できる場合：
  - **1つの番組セル**として表示する（列内分割しない）

### 7.3 共通番組（サイマル）の判定ルール
programsには relatedItems があり、これを優先して「共通番組グループ」を判定する。

- **relatedItemsが示す共有（type="shared"）を第一優先**で共通判定に利用する
- relatedItems が無い/不十分な場合のみフォールバック判定を使う

フォールバック（要件として許容する最低限）：
- `(startAt, duration, name)` が一致する番組は共通扱いにしてよい
- ただし “あいまい一致” はしない（誤統合の原因になるため）

### 7.4 列ヘッダ表示
- GR/BS統合列：channels側の name を基本表示名とする
- CS列：service名を列名とする
- 補助情報（任意）：remoteControlKeyId（地上波）、ロゴ

## 8. 番組の時間軸と日付セクション
### 8.1 日付セクション
- programsは8日分が混在で返る前提なので、`startAt` を基にローカル日付へ変換し、
  - 今日〜7日後の8セクションへ分類して縦に連結表示する

### 8.2 深夜またぎ
- 番組は日付境界を跨ぐ可能性がある
- 表示上は「開始日のセクションに属する」で良いが、セクション境界での見切れを避ける（必要なら切り分け表示）

## 9. レスポンシブ要件
- スマホ幅でも破綻しない（横スクロールは許容）
- タップしやすさを確保（セルの最小高さ・余白）
- 文字は省略しても良い（2行まで + 省略記号など）
- 日付リンクやタブは横に詰める/スクロール可能でも良い

## 10. パフォーマンス要件（必須）
- `programsUrl` は8日分一括のためデータ量が大きい。  
  DOMを番組数そのまま作ると重くなるので、以下のいずれか（または併用）を必ず行う：

必須のいずれか：
1) **日付セクション単位の遅延レンダリング**
   - IntersectionObserver 等で近づいた日だけDOM生成
2) **縦方向の簡易バーチャライズ**
   - viewport付近の時間帯のみ番組DOMを保持する

追加推奨：
- イベントは委譲（containerで1つのclickハンドラ）
- リサイズ時の再計算は debounce
- スクロールに同期した重い計算は避ける（requestAnimationFrame利用）

## 11. アクセシビリティ
- タブ/日付リンクはキーボードで操作可能
- 番組セルはフォーカス可能にし、Enterで詳細を開ける
- 色だけに依存しない“いま放送中”表現（ライン等）

## 12. エラー/空状態
- API取得失敗：Bootstrapの alert で明示し、再試行ボタンを出す
- 番組が空：空状態メッセージを表示
- 欠損データ：title等が無ければ「（番組情報なし）」などで落ちないようにする

## 13. 設定（Config）
最低限：
- `endpoints: { servicesUrl, channelsUrl, programsUrl }`
- `days: number`（既定8）
- `initialTab: "GR"|"BS"|"CS"`
- `includeServiceTypes: number[]`（既定 `[1]`）
- `timezone: string`（既定 `"Asia/Tokyo"`）
- `pxPerMinute: number`（時間軸スケール）

任意（拡張ポイント）：
- `onProgramClick(program)`：クリック時コールバック
- `logoResolver(service): string|null`：logoId等から画像URLを作る場合
- `nowLine: boolean`：現在ライン表示切替

## 14. 受け入れ条件（Acceptance Criteria）
- 1つの `<div>` を指定して `mount()` するだけで番組表が表示される
- GR/BS/CS タブで切替できる（ページ遷移なし）
- 日付リンクで該当日へスクロールできる（ページ遷移なし）
- 8日分が縦に連続して表示される
- **GR/BSは同一物理チャンネルが基本1列**で表示される
- GR/BSでサブチャンネルが別番組の時間帯のみ、**列内が横分割**される
- CSはサービスごとに列表示で良い
- スマホ幅でも操作でき、致命的に重くならない（遅延描画/簡易バーチャライズのいずれかを実装）
- UI変更後のスクリーンショットは、/demo/index.htmlを撮影する。